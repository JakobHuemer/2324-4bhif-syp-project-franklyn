<div class="container h-100, d-flex flex-column">
  <div class="row h-bar">
    <div class="col-1 d-flex align-items-center">
      <h6 class="align-middle d-table-cell text-center">CPU Utilization</h6>
    </div>
    <div class="col-10">
      <canvas
        baseChart
        [data]="cpuChartData"
        [type]="cpuChartType"
        [options]="cpuChartOptions" class="h-bar">
      </canvas>
    </div>
    <div class="col-1 d-flex align-items-center">
      <h6 class="align-middle d-table-cell text-center">{{store.value
        .metricsDashboardModel
        .serverMetrics
        .cpuUsagePercent
        .toFixed(1)}} %</h6>
    </div>
  </div>
  <div class="row">
    <div class="col-6">
      <canvas
        baseChart
        [data]="diskChartData"
        [type]="diskChartType"
        [plugins]="[ diskDoughnutLabel ]"
        [options]="diskChartOptions">
      </canvas>
    </div>
    <div class="col-6">
      <canvas
        baseChart
        [data]="memChartData"
        [type]="memChartType"
        [plugins]="[ memoryDoughnutLabel ]"
        [options]="memChartOptions">
      </canvas>
    </div>
  </div>

  <!-- Profiling Metrics Section -->
  <div class="row mt-4" *ngIf="profilingMetrics">
    <div class="col-12">
      <hr class="my-3">
      <h4 class="mb-3">Profiling Metrics</h4>
    </div>
  </div>

  <!-- Queue Status Panel -->
  <div class="row" *ngIf="profilingMetrics">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Screenshot Pipeline Status</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-2 text-center">
              <div class="metric-value" [style.color]="getQueueHealthColor()">
                {{ profilingMetrics.queueSize }}
              </div>
              <div class="metric-label">Queue Size</div>
            </div>
            <div class="col-md-2 text-center">
              <div class="metric-value">
                {{ profilingMetrics.activeRequests }}
              </div>
              <div class="metric-label">Active Requests</div>
            </div>
            <div class="col-md-2 text-center">
              <div class="metric-value">
                {{ profilingMetrics.connectedClients }}
              </div>
              <div class="metric-label">Connected Clients</div>
            </div>
            <div class="col-md-2 text-center">
              <div class="metric-value">
                {{ profilingMetrics.uploadsPerSecond.toFixed(1) }}
              </div>
              <div class="metric-label">Uploads/sec</div>
            </div>
            <div class="col-md-2 text-center">
              <div class="metric-value text-danger">
                {{ profilingMetrics.timeoutsTotal }}
              </div>
              <div class="metric-label">Timeouts (total)</div>
            </div>
            <div class="col-md-2 text-center">
              <div class="metric-value">
                {{ profilingMetrics.uploadsTotal }}
              </div>
              <div class="metric-label">Uploads (total)</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Video Jobs and Image Sizes -->
  <div class="row" *ngIf="profilingMetrics">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Video Generation</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6 text-center">
              <div class="metric-value">
                {{ profilingMetrics.videoJobsQueued }}
              </div>
              <div class="metric-label">Jobs Queued</div>
            </div>
            <div class="col-6 text-center">
              <div class="metric-value">
                {{ profilingMetrics.videoJobsActive }}
              </div>
              <div class="metric-label">Jobs Active</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Average Image Sizes</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6 text-center">
              <div class="metric-value">
                {{ formatBytes(profilingMetrics.averageImageUploadSizeBytes) }}
              </div>
              <div class="metric-label">Upload Size</div>
            </div>
            <div class="col-6 text-center">
              <div class="metric-value">
                {{ formatBytes(profilingMetrics.averageImageDownloadSizeBytes) }}
              </div>
              <div class="metric-label">Download Size</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Pipeline Timeline Chart -->
  <div class="row" *ngIf="profilingMetrics && historicalData.length > 0">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Request Pipeline Timeline (p50 latencies, 5-min rolling window)</h5>
        </div>
        <div class="card-body" style="height: 300px;">
          <canvas
            baseChart
            [data]="timelineChartData"
            [type]="timelineChartType"
            [options]="timelineChartOptions">
          </canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Processing Time Breakdown Chart -->
  <div class="row" *ngIf="profilingMetrics">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Processing Time Breakdown (p50 per screenshot)</h5>
        </div>
        <div class="card-body" style="height: 120px;">
          <canvas
            baseChart
            [data]="breakdownChartData"
            [type]="breakdownChartType"
            [options]="breakdownChartOptions">
          </canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Latency Histogram Table -->
  <div class="row" *ngIf="profilingMetrics && latencyMetrics.length > 0">
    <div class="col-12">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Operation Latencies (ms)</h5>
        </div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0">
            <thead>
              <tr>
                <th>Operation</th>
                <th class="text-end">p50</th>
                <th class="text-end">p90</th>
                <th class="text-end">p99</th>
                <th class="text-end">Max</th>
                <th class="text-end">Count</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let metric of latencyMetrics">
                <td>{{ metric.name }}</td>
                <td class="text-end">{{ formatMs(metric.data.p50Ms) }}</td>
                <td class="text-end">{{ formatMs(metric.data.p90Ms) }}</td>
                <td class="text-end">{{ formatMs(metric.data.p99Ms) }}</td>
                <td class="text-end">{{ formatMs(metric.data.maxMs) }}</td>
                <td class="text-end">{{ metric.data.count }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Vert.x Thread Pool Metrics -->
  <div class="row" *ngIf="profilingMetrics">
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Vert.x Worker Pool</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-4 text-center">
              <div class="metric-value" [style.color]="getPoolHealthColor(profilingMetrics.vertxWorkerPool.ratio)">
                {{ (profilingMetrics.vertxWorkerPool.ratio * 100).toFixed(0) }}%
              </div>
              <div class="metric-label">Utilization</div>
            </div>
            <div class="col-4 text-center">
              <div class="metric-value">
                {{ profilingMetrics.vertxWorkerPool.inUse }} / {{ profilingMetrics.vertxWorkerPool.poolSize }}
              </div>
              <div class="metric-label">In Use / Pool Size</div>
            </div>
            <div class="col-4 text-center">
              <div class="metric-value">
                {{ profilingMetrics.vertxWorkerPool.queueSize }}
              </div>
              <div class="metric-label">Queue Size</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0">Vert.x Event Loop</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-4 text-center">
              <div class="metric-value" [style.color]="getPoolHealthColor(profilingMetrics.vertxEventLoop.ratio)">
                {{ (profilingMetrics.vertxEventLoop.ratio * 100).toFixed(0) }}%
              </div>
              <div class="metric-label">Utilization</div>
            </div>
            <div class="col-4 text-center">
              <div class="metric-value">
                {{ profilingMetrics.vertxEventLoop.inUse }} / {{ profilingMetrics.vertxEventLoop.poolSize }}
              </div>
              <div class="metric-label">In Use / Pool Size</div>
            </div>
            <div class="col-4 text-center">
              <div class="metric-value">
                {{ profilingMetrics.vertxEventLoop.queueSize }}
              </div>
              <div class="metric-label">Queue Size</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
